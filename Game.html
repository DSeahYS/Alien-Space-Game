<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes of the Unknown: Scavenger Class</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Segoe UI', 'Courier New', monospace;
            user-select: none;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: 80px 1fr 150px;
            padding: 20px;
            box-sizing: border-box;
        }

        .panel {
            background: rgba(20, 30, 40, 0.6);
            border: 1px solid rgba(100, 200, 255, 0.2);
            backdrop-filter: blur(8px);
            padding: 15px;
            color: #cef;
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            display: flex;
            flex-direction: column;
        }

        #mission-panel {
            grid-column: 1;
            grid-row: 1 / span 2;
            gap: 10px;
            border-left: 3px solid #00eaff;
        }

        .mission-header {
            font-size: 12px;
            color: #00eaff;
            letter-spacing: 2px;
            font-weight: bold;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 5px;
        }

        .log-scroll {
            flex-grow: 1;
            overflow-y: auto;
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            font-size: 11px;
            display: flex;
            flex-direction: column-reverse;
            gap: 6px;
        }

        .log-entry {
            padding: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            animation: fadeIn 0.3s;
        }

        .rarity-legendary {
            color: #ffd700;
            border-left: 2px solid #ffd700;
        }

        .rarity-rare {
            color: #d4aaff;
            border-left: 2px solid #d4aaff;
        }

        .rarity-common {
            color: #aaaaaa;
            border-left: 2px solid #888;
        }

        #status-panel {
            grid-column: 3;
            grid-row: 1;
            text-align: right;
            border-right: 3px solid #ffd700;
        }

        .big-text {
            font-size: 28px;
            font-weight: 300;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        #systems-panel {
            grid-column: 3;
            grid-row: 3;
            justify-content: flex-end;
            text-align: right;
        }

        .bar-container {
            width: 100%;
            height: 6px;
            background: #111;
            margin-top: 5px;
            border-radius: 3px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            width: 100%;
            transition: width 0.1s;
        }

        #shop-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 700px;
            height: 500px;
            background: rgba(10, 15, 20, 0.95);
            border: 1px solid #444;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: none;
            flex-direction: column;
            padding: 40px;
            color: white;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #333;
            padding: 20px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .shop-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #fff;
        }

        .btn-buy {
            background: #ffd700;
            color: black;
            border: none;
            padding: 8px;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }

        #center-msg {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
            pointer-events: none;
        }

        .msg-title {
            font-size: 40px;
            font-weight: 100;
            letter-spacing: 10px;
            color: white;
            text-shadow: 0 0 20px #00eaff;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #game-over {
            position: absolute;
            inset: 0;
            background: rgba(20, 0, 0, 0.9);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }

        .glitch-text {
            font-size: 80px;
            font-weight: 900;
            color: #ff3333;
            text-shadow: 2px 2px 0px #fff;
            letter-spacing: 5px;
        }

        .btn-restart {
            margin-top: 40px;
            padding: 15px 40px;
            background: transparent;
            border: 2px solid #ff3333;
            color: #ff3333;
            font-size: 20px;
            cursor: pointer;
            transition: 0.2s;
            font-family: inherit;
            letter-spacing: 3px;
        }

        .btn-restart:hover {
            background: #ff3333;
            color: black;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }
    </style>
</head>

<body>
    <div id="ui-layer">
        <div id="mission-panel" class="panel">
            <div class="mission-header">SHIP AI LOG // UPLINK ACTIVE</div>
            <div id="log-box" class="log-scroll">
                <div class="log-entry">System Online. Physics engine engaged.</div>
                <div class="log-entry" style="color:#00eaff">W=Thrust | Q/E=Turn | Shift=Boost | TAB=Shop</div>
            </div>
        </div>
        <div id="status-panel" class="panel">
            <div style="font-size: 10px; color: #888; letter-spacing: 2px;">CREDITS</div>
            <div id="credits-val" class="big-text">0</div>
        </div>
        <div id="systems-panel" class="panel">
            <div style="font-size: 12px; color:#888;">SHIELD INTEGRITY</div>
            <div class="bar-container">
                <div id="shield-bar" class="bar-fill" style="background: #00eaff;"></div>
            </div>
            <div style="margin-top:10px; font-size: 12px; color:#888;">HULL INTEGRITY</div>
            <div class="bar-container">
                <div id="hull-bar" class="bar-fill" style="background: #ff4444;"></div>
            </div>
            <div style="margin-top:10px; font-size: 12px; color:#888;">ENERGY CELL</div>
            <div class="bar-container">
                <div id="energy-bar" class="bar-fill" style="background: #ffd700;"></div>
            </div>
            <div style="margin-top:10px; font-size: 12px; color:#888;">VELOCITY</div>
            <div id="spd-val" style="font-size: 18px; color: white;">0 M/S</div>
        </div>
    </div>
    <div id="center-msg">
        <div id="msg-text" class="msg-title">SIGNAL DETECTED</div>
    </div>
    <div id="game-over">
        <div class="glitch-text">CRITICAL FAILURE</div>
        <div style="color: #aaa; margin-top: 10px; font-size: 14px;">SHIP DESTROYED</div>
        <button class="btn-restart" onclick="location.reload()">REBOOT SYSTEM</button>
    </div>
    <div id="shop-modal">
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:20px;">
            <span style="font-size:24px; letter-spacing:5px;">FABRICATOR</span>
            <span style="font-size:12px; color:#888; cursor:pointer;" onclick="toggleShop()">[CLOSE]</span>
        </div>
        <div class="shop-grid" id="shop-grid"></div>
    </div>
    <div id="canvas-container"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const apiKey = "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";
        const CONFIG = {
            colors: { fog: 0x18101a, light: 0xffaa88, groundHigh: 0x554455, groundLow: 0x111111 },
            terrain: { size: 4000, res: 128 },
            physics: { accel: 60.0, drag: 1.2, turnSpeed: 1.5, boostMult: 2.0, bankAngle: 0.5 },
            game: { energyDrain: 30, energyRecharge: 10 }
        };
        const STATE = {
            credits: 0, energy: 100, shield: 100, hull: 100,
            missionActive: false, paused: false, gameOver: false,
            upgrades: {
                speed: { level: 1, cost: 250, name: "Fusion Thrusters", desc: "Increases acceleration." },
                radar: { level: 1, cost: 150, name: "Deep-Scan Array", desc: "Higher chance of Legendary loot." },
                efficiency: { level: 1, cost: 300, name: "Zero-Point Module", desc: "Reduces boost energy cost." },
                shield: { level: 1, cost: 500, name: "Impact Dampeners", desc: "Increases max shield." }
            },
            currentObj: null, velocity: new THREE.Vector3(), mines: []
        };
        const INPUTS = { w: 0, s: 0, q: 0, e: 0, shift: 0 };
        let scene, camera, renderer, clock;
        let shipRoot, shipModel, terrainMesh, particles;
        let ruins = [];

        function init() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.colors.fog);
            scene.fog = new THREE.FogExp2(CONFIG.colors.fog, 0.0015);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 3000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const amb = new THREE.AmbientLight(0x404040, 1.5);
            scene.add(amb);
            const sun = new THREE.DirectionalLight(CONFIG.colors.light, 1.2);
            sun.position.set(500, 1000, 500);
            sun.castShadow = true;
            scene.add(sun);

            createTerrain();
            createRuins();
            createShip();
            createParticles();
            spawnMines(20);

            window.addEventListener('resize', onResize);
            document.addEventListener('keydown', onKey);
            document.addEventListener('keyup', onKeyUp);

            startMission();
            renderShop();
            animate();
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function getTerrainHeight(x, z) {
            return (Math.sin(x * 0.003) * Math.cos(z * 0.003) * 150) +
                (Math.sin(x * 0.01 + z * 0.01) * 40) +
                (Math.abs(Math.sin(x * 0.05) * Math.cos(z * 0.05)) * 30);
        }

        function createTerrain() {
            const geo = new THREE.PlaneGeometry(CONFIG.terrain.size, CONFIG.terrain.size, 128, 128);
            geo.rotateX(-Math.PI / 2);
            const verts = geo.attributes.position.array;
            const colors = [];
            const colHigh = new THREE.Color(CONFIG.colors.groundHigh);
            const colLow = new THREE.Color(CONFIG.colors.groundLow);
            for (let i = 0; i < verts.length; i += 3) {
                const x = verts[i];
                const z = verts[i + 2];
                const y = getTerrainHeight(x, z);
                verts[i + 1] = y;
                const mix = (y + 50) / 200;
                const col = colLow.clone().lerp(colHigh, Math.max(0, Math.min(1, mix)));
                colors.push(col.r, col.g, col.b);
            }
            geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geo.computeVertexNormals();
            const mat = new THREE.MeshStandardMaterial({
                vertexColors: true, roughness: 0.8, metalness: 0.2, flatShading: true
            });
            terrainMesh = new THREE.Mesh(geo, mat);
            terrainMesh.receiveShadow = true;
            scene.add(terrainMesh);
        }

        function createRuins() {
            const mat = new THREE.MeshStandardMaterial({
                color: 0x111111, roughness: 0.1, metalness: 0.9,
                emissive: 0x001133, emissiveIntensity: 0.2
            });
            for (let i = 0; i < 50; i++) {
                const x = (Math.random() - 0.5) * 3000;
                const z = (Math.random() - 0.5) * 3000;
                const y = getTerrainHeight(x, z);
                const h = 50 + Math.random() * 150;
                const geo = new THREE.BoxGeometry(10 + Math.random() * 20, h, 10 + Math.random() * 20);
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(x, y + h / 2, z);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.rotation.z = (Math.random() - 0.5) * 0.3;
                scene.add(mesh);
                ruins.push(mesh);
            }
        }

        function createShip() {
            shipRoot = new THREE.Group();
            shipModel = new THREE.Group();
            shipRoot.add(shipModel);
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0x778899, roughness: 0.4, metalness: 0.8 });
            const glowMat = new THREE.MeshBasicMaterial({ color: 0x00eaff });
            const body = new THREE.Mesh(new THREE.ConeGeometry(1.5, 8, 6), bodyMat);
            body.rotation.x = Math.PI / 2;
            shipModel.add(body);
            const wings = new THREE.Mesh(new THREE.BoxGeometry(8, 0.2, 3), bodyMat);
            wings.position.set(0, 0, 2);
            shipModel.add(wings);
            const engineGlow = new THREE.Mesh(new THREE.SphereGeometry(0.8), glowMat);
            engineGlow.position.set(0, 0, 4);
            shipModel.add(engineGlow);
            const light = new THREE.PointLight(0x00eaff, 1, 20);
            light.position.set(0, 0, 4);
            shipModel.add(light);
            const startY = Math.max(200, getTerrainHeight(0, 0) + 100);
            shipRoot.position.set(0, startY, 0);
            scene.add(shipRoot);
        }

        function createParticles() {
            const count = 2000;
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for (let i = 0; i < count; i++) {
                pos.push((Math.random() - 0.5) * 1000, (Math.random() - 0.5) * 500, (Math.random() - 0.5) * 1000);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ color: 0x88aaaa, size: 0.8, transparent: true, opacity: 0.5 });
            particles = new THREE.Points(geo, mat);
            scene.add(particles);
        }

        function spawnMines(count) {
            const geo = new THREE.DodecahedronGeometry(4, 0);
            const mat = new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0x550000, roughness: 0.2, metalness: 0.8 });
            for (let i = 0; i < count; i++) {
                const mesh = new THREE.Mesh(geo, mat);
                const angle = Math.random() * Math.PI * 2;
                const dist = 300 + Math.random() * 1000;
                const x = Math.cos(angle) * dist;
                const z = Math.sin(angle) * dist;
                const y = getTerrainHeight(x, z) + 50 + Math.random() * 200;
                mesh.position.set(x, y, z);
                for (let j = 0; j < 6; j++) {
                    const spike = new THREE.Mesh(new THREE.ConeGeometry(0.5, 5, 4), mat);
                    spike.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, 0);
                    mesh.add(spike);
                }
                STATE.mines.push(mesh);
                scene.add(mesh);
            }
        }

        function startMission() {
            if (STATE.currentObj) scene.remove(STATE.currentObj);
            const angle = Math.random() * Math.PI * 2;
            const dist = 800 + Math.random() * 600;
            const x = shipRoot.position.x + Math.cos(angle) * dist;
            const z = shipRoot.position.z + Math.sin(angle) * dist;
            const y = getTerrainHeight(x, z) + 50;
            const type = Math.random() > 0.6 ? 'ARTIFACT' : 'CACHE';
            const col = type === 'ARTIFACT' ? 0x ff00ff: 0x00eaff;
            const geo = type === 'ARTIFACT' ? new THREE.IcosahedronGeometry(15, 0) : new THREE.OctahedronGeometry(10, 0);
            const mat = new THREE.MeshStandardMaterial({
                color: col, emissive: col, emissiveIntensity: 2, wireframe: true
            });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, y, z);
            const light = new THREE.PointLight(col, 2, 400);
            mesh.add(light);
            const beam = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, 1000, 8),
                new THREE.MeshBasicMaterial({ color: col, transparent: true, opacity: 0.3 })
            );
            beam.position.y = 500;
            mesh.add(beam);
            scene.add(mesh);
            STATE.currentObj = mesh;
            STATE.currentObj.userData = { type: type };
            STATE.missionActive = true;
            showMsg("SCAN SIGNATURE DETECTED");
            addLog("New energy signature detected on sensors.", "common");
        }

        function completeMission() {
            if (!STATE.missionActive) return;
            STATE.missionActive = false;
            scene.remove(STATE.currentObj);
            showMsg("ACQUISITION COMPLETE");
            const baseVal = 200;
            const roll = Math.random() + (STATE.upgrades.radar.level * 0.15);
            let rarity = "COMMON";
            let mult = 1;
            if (roll > 1.4) { rarity = "LEGENDARY"; mult = 10; }
            else if (roll > 0.95) { rarity = "RARE"; mult = 3; }
            const val = Math.floor(baseVal * mult);
            STATE.credits += val;
            updateUI();
            analyzeLoot(STATE.currentObj.userData.type, rarity, val);
            setTimeout(startMission, 3000);
        }

        function takeDamage(amount) {
            if (STATE.gameOver) return;
            if (STATE.shield > 0) {
                STATE.shield -= amount;
                if (STATE.shield < 0) {
                    STATE.hull += STATE.shield;
                    STATE.shield = 0;
                }
            } else {
                STATE.hull -= amount;
            }
            camera.position.x += (Math.random() - 0.5) * 5;
            camera.position.y += (Math.random() - 0.5) * 5;
            if (STATE.hull <= 0) {
                triggerGameOver();
            }
            updateUI();
        }

        function triggerGameOver() {
            STATE.gameOver = true;
            STATE.hull = 0;
            document.getElementById('game-over').style.display = 'flex';
            const expGeo = new THREE.SphereGeometry(10, 16, 16);
            const expMat = new THREE.MeshBasicMaterial({ color: 0xff5500 });
            for (let i = 0; i < 20; i++) {
                const p = new THREE.Mesh(expGeo, expMat);
                p.position.copy(shipRoot.position);
                p.position.x += (Math.random() - 0.5) * 20;
                p.position.y += (Math.random() - 0.5) * 20;
                p.position.z += (Math.random() - 0.5) * 20;
                scene.add(p);
            }
            scene.remove(shipRoot);
        }

        async function analyzeLoot(type, rarity, val) {
            addLog("Analyzing artifact structure...", "common");
            if (!apiKey) {
                addLog(`Found: ${rarity} Artifact (${val} CR)`, rarity.toLowerCase());
                return;
            }
            const prompt = `Sci-fi game loot generator. Item: ${type}, Rarity: ${rarity}. Format: Name|Description`;
            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Alien Space Game'
                    },
                    body: JSON.stringify({
                        model: "google/gemini-2.0-flash-exp:free",
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await res.json();
                if (!data.choices) throw new Error("No response");
                const txt = data.choices[0].message.content;
                const [name, desc] = txt.split('|');
                addLog(`FOUND: ${name ? name.trim() : 'Unknown'}`, rarity.toLowerCase());
                addLog(`"${desc ? desc.trim() : '...'}" (+${val} CR)`, "common");
            } catch (e) {
                addLog(`Decryption Failed. Value: ${val} CR`, rarity.toLowerCase());
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (STATE.paused || STATE.gameOver) return;
            const dt = Math.min(clock.getDelta(), 0.1);

            let boosting = INPUTS.shift && STATE.energy > 0;
            if (boosting) {
                STATE.energy -= CONFIG.game.energyDrain * (2 - STATE.upgrades.efficiency.level * 0.2) * dt;
                if (STATE.energy <= 0) boosting = false;
            } else {
                STATE.energy += CONFIG.game.energyRecharge * dt;
            }
            STATE.energy = Math.max(0, Math.min(100, STATE.energy));

            const thrust = new THREE.Vector3(0, 0, -1).applyQuaternion(shipRoot.quaternion);
            let accel = 0;
            if (INPUTS.w) accel = CONFIG.physics.accel * (1 + STATE.upgrades.speed.level * 0.2) * (boosting ? CONFIG.physics.boostMult : 1.0);
            if (INPUTS.s) accel = -CONFIG.physics.accel * 0.5;

            STATE.velocity.add(thrust.multiplyScalar(accel * dt));
            STATE.velocity.multiplyScalar(1.0 - (CONFIG.physics.drag * dt));
            shipRoot.position.add(STATE.velocity.clone().multiplyScalar(dt));

            const turnS = CONFIG.physics.turnSpeed * dt;
            shipRoot.rotateY((INPUTS.q - INPUTS.e) * turnS);

            const targetRoll = (INPUTS.e - INPUTS.q) * CONFIG.physics.bankAngle;
            shipModel.rotation.z = THREE.MathUtils.lerp(shipModel.rotation.z, targetRoll, dt * 5);

            const groundH = getTerrainHeight(shipRoot.position.x, shipRoot.position.z);
            if (shipRoot.position.y < groundH + 5) {
                triggerGameOver();
            }

            for (let mine of STATE.mines) {
                mine.rotation.x += dt;
                mine.rotation.y += dt;
                if (shipRoot.position.distanceTo(mine.position) < 10) {
                    takeDamage(40);
                    STATE.velocity.multiplyScalar(-0.5);
                }
            }

            const camOffset = new THREE.Vector3(0, 15, 40).applyMatrix4(shipRoot.matrixWorld);
            camera.position.lerp(camOffset, 0.1);
            camera.lookAt(shipRoot.position.clone().add(new THREE.Vector3(0, 0, -100).applyQuaternion(shipRoot.quaternion)));

            updateTerrain();
            particles.position.copy(shipRoot.position);
            if (STATE.currentObj) {
                STATE.currentObj.rotation.y += dt;
                if (shipRoot.position.distanceTo(STATE.currentObj.position) < 60) completeMission();
            }

            if (STATE.shield < 100) STATE.shield += dt * 2;

            updateUI();
            renderer.render(scene, camera);
        }

        function updateTerrain() {
            const snap = 100;
            terrainMesh.position.x = Math.floor(shipRoot.position.x / snap) * snap;
            terrainMesh.position.z = Math.floor(shipRoot.position.z / snap) * snap;
        }

        function updateUI() {
            document.getElementById('credits-val').innerText = STATE.credits;
            document.getElementById('spd-val').innerText = Math.floor(STATE.velocity.length()) + " M/S";
            document.getElementById('energy-bar').style.width = STATE.energy + "%";
            document.getElementById('shield-bar').style.width = STATE.shield + "%";
            document.getElementById('hull-bar').style.width = STATE.hull + "%";
        }

        function addLog(text, style) {
            const box = document.getElementById('log-box');
            const div = document.createElement('div');
            div.className = `log-entry rarity-${style}`;
            div.innerText = text;
            box.prepend(div);
            if (box.children.length > 10) box.lastChild.remove();
        }

        function showMsg(text) {
            const el = document.getElementById('msg-text');
            el.innerText = text;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 2500);
        }

        function toggleShop() {
            STATE.paused = !STATE.paused;
            const modal = document.getElementById('shop-modal');
            modal.style.display = STATE.paused ? 'flex' : 'none';
            if (STATE.paused) renderShop();
            else {
                clock.getDelta();
                requestAnimationFrame(animate);
            }
        }

        function renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            Object.keys(STATE.upgrades).forEach(key => {
                const item = STATE.upgrades[key];
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div style="font-weight:bold; color:#00eaff">${item.name} <span style="color:#fff; font-size:10px">LVL ${item.level}</span></div>
                    <div style="font-size:11px; color:#aaa">${item.desc}</div>
                    <button class="btn-buy" onclick="buyUpgrade('${key}')">INSTALL (${item.cost} CR)</button>
                `;
                grid.appendChild(div);
            });
        }

        function buyUpgrade(key) {
            const item = STATE.upgrades[key];
            if (STATE.credits >= item.cost) {
                STATE.credits -= item.cost;
                item.level++;
                item.cost = Math.floor(item.cost * 1.4);
                addLog(`Installed ${item.name} Lvl ${item.level}`, "common");
                renderShop();
                updateUI();
            } else {
                add Log("Insufficient Funds.", "common");
            }
        }

        function onKey(e) {
            if (e.code === 'Tab') { e.preventDefault(); toggleShop(); return; }
            if (STATE.paused) return;
            if (e.code === 'KeyW') INPUTS.w = 1;
            if (e.code === 'KeyS') INPUTS.s = 1;
            if (e.code === 'KeyQ') INPUTS.q = 1;
            if (e.code === 'KeyE') INPUTS.e = 1;
            if (e.code === 'ShiftLeft') INPUTS.shift = 1;
        }

        function onKeyUp(e) {
            if (e.code === 'KeyW') INPUTS.w = 0;
            if (e.code === 'KeyS') INPUTS.s = 0;
            if (e.code === 'KeyQ') INPUTS.q = 0;
            if (e.code === 'KeyE') INPUTS.e = 0;
            if (e.code === 'ShiftLeft') INPUTS.shift = 0;
        }

        window.onload = init;
    </script>
</body>

</html>