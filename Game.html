<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactical Scavenger: Radar Ops</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Segoe UI', 'Courier New', monospace;
            user-select: none;
        }

        /* --- HUD LAYER --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: 80px 1fr 200px;
            padding: 25px; box-sizing: border-box;
        }

        /* GLASS PANELS */
        .panel {
            background: rgba(10, 15, 20, 0.7);
            border: 1px solid rgba(0, 255, 200, 0.15);
            backdrop-filter: blur(8px);
            padding: 15px;
            color: #cef;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
            display: flex; flex-direction: column;
        }

        /* TOP RIGHT: CREDITS */
        #status-panel {
            grid-column: 3; grid-row: 1;
            text-align: right;
            border-right: 4px solid #ffd700;
            justify-content: center;
        }
        .credits-val { font-size: 32px; font-weight: 300; color: #fff; text-shadow: 0 0 15px rgba(255,215,0,0.4); }
        .credits-label { font-size: 10px; color: #ffd700; letter-spacing: 2px; }

        /* BOTTOM CENTER: RADAR */
        #radar-container {
            grid-column: 2; grid-row: 3;
            display: flex; justify-content: center; align-items: flex-end;
        }
        #radar {
            width: 220px; height: 220px;
            background: radial-gradient(circle, rgba(0,20,0,0.9) 0%, rgba(0,10,0,0.9) 100%);
            border: 2px solid #3f3;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 25px rgba(0, 255, 100, 0.2);
        }
        #radar-canvas { border-radius: 50%; width: 100%; height: 100%; }

        /* BOTTOM RIGHT: SYSTEMS */
        #systems-panel {
            grid-column: 3; grid-row: 3;
            justify-content: flex-end; text-align: right;
        }
        .stat-label { font-size: 10px; color: #888; letter-spacing: 1px; }
        .stat-val { font-size: 18px; color: white; font-weight: bold; margin-bottom: 8px; }
        .bar-bg { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 50%; background: #00eaff; transition: width 0.1s; }

        /* TOP LEFT: NOTIFICATIONS */
        #log-panel {
            grid-column: 1; grid-row: 1 / span 2;
            background: transparent; border: none; box-shadow: none; backdrop-filter: none;
            justify-content: flex-start;
        }
        .log-entry {
            font-size: 12px; margin-bottom: 5px; padding: 5px 8px;
            background: rgba(0,0,0,0.4); border-left: 3px solid #ccc;
            animation: fadeSlide 0.3s ease-out; color: #ddd;
        }
        .log-legendary { border-color: #ffd700; color: #ffe; box-shadow: 0 0 10px rgba(255,215,0,0.2); }
        .log-rare { border-color: #d4aaff; color: #eef; }
        
        @keyframes fadeSlide { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        /* CONTROLS OVERLAY */
        #controls-hint {
            position: absolute; top: 110px; right: 25px;
            text-align: right; font-size: 10px; color: #555;
            pointer-events: none;
        }
        .key { border: 1px solid #444; padding: 1px 3px; border-radius: 2px; color: #888; }

        /* SHOP MODAL */
        #shop-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 700px; height: 500px;
            background: rgba(8, 12, 16, 0.98);
            border: 1px solid #333;
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
            z-index: 100; display: none;
            flex-direction: column; padding: 40px; color: white;
        }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; overflow-y: auto; }
        .shop-item {
            background: rgba(255,255,255,0.03); border: 1px solid #333; padding: 15px;
            cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 5px;
        }
        .shop-item:hover { background: rgba(0, 234, 255, 0.05); border-color: #00eaff; }
        .btn-buy { 
            background: #ffd700; color: black; border: none; padding: 8px; 
            font-weight: bold; margin-top: 10px; cursor: pointer; text-transform: uppercase;
        }

        #canvas-container { position: absolute; top: 0; left: 0; z-index: 0; }
        #center-msg { 
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 32px; color: white; opacity: 0; transition: opacity 0.5s; 
            text-shadow: 0 0 20px #00eaff; font-weight: 100; letter-spacing: 5px; text-align: center;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <!-- LOG -->
        <div id="log-panel">
            <!-- JS inserts logs here -->
        </div>

        <!-- CREDITS -->
        <div id="status-panel" class="panel">
            <div class="credits-label">CREDITS</div>
            <div id="credits-val" class="credits-val">0</div>
        </div>

        <!-- CONTROLS -->
        <div id="controls-hint">
            <div>PITCH: <span class="key">W</span> <span class="key">S</span></div>
            <div style="margin-top:2px">ROLL: <span class="key">A</span> <span class="key">D</span></div>
            <div style="margin-top:2px">YAW: <span class="key">Q</span> <span class="key">E</span></div>
            <div style="margin-top:2px">THROTTLE: <span class="key">SHIFT</span> <span class="key">CTRL</span></div>
            <div style="margin-top:2px">SHOP: <span class="key">TAB</span></div>
        </div>

        <!-- RADAR -->
        <div id="radar-container">
            <div id="radar">
                <canvas id="radar-canvas" width="220" height="220"></canvas>
            </div>
        </div>

        <!-- SYSTEMS -->
        <div id="systems-panel" class="panel">
            <div class="stat-label">VELOCITY</div>
            <div id="spd-val" class="stat-val">0 KM/H</div>
            <div class="stat-label">ALTITUDE</div>
            <div id="alt-val" class="stat-val">0 M</div>
            <div class="stat-label">ENERGY</div>
            <div class="bar-bg"><div id="energy-bar" class="bar-fill"></div></div>
        </div>
    </div>

    <div id="center-msg">TARGET ACQUIRED</div>

    <!-- SHOP MODAL -->
    <div id="shop-modal">
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:15px;">
            <span style="font-size:24px; letter-spacing:4px; font-weight:300;">OUTFITTING</span>
            <span style="font-size:12px; color:#666; cursor:pointer; padding-top:10px;" onclick="toggleShop()">[CLOSE]</span>
        </div>
        <div class="shop-grid" id="shop-grid"></div>
    </div>

    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // CONFIG
        const CONFIG = {
            colors: { fog: 0x121015, light: 0xffaa88 },
            flight: {
                maxSpeedBase: 3.5,
                accel: 2.0,
                brake: 3.0,
                turnSpeed: 1.0,
                pitchSpeed: 0.8,
                rollSpeed: 1.2
            }
        };

        // STATE
        const STATE = {
            credits: 0,
            energy: 100,
            throttle: 0,
            missionActive: false,
            paused: false,
            currentObj: null,
            upgrades: {
                engine: { lvl: 1, cost: 200, name: "Ion Thruster", desc: "Boosts Top Speed" },
                radar:  { lvl: 1, cost: 150, name: "Sensor Array", desc: "Detects High-Value Loot" },
                battery:{ lvl: 1, cost: 300, name: "Plasma Cell", desc: "Energy Regen Rate" },
                hull:   { lvl: 1, cost: 500, name: "Nanite Armor", desc: "Impact Durability" }
            }
        };

        const INPUT = { w:0, s:0, a:0, d:0, q:0, e:0, shift:0, ctrl:0 };

        // THREE GLOBALS
        let scene, camera, renderer, clock;
        let ship, terrain, particles;
        let radarCtx;

        // --- INIT ---
        function init() {
            clock = new THREE.Clock();

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.colors.fog);
            scene.fog = new THREE.FogExp2(CONFIG.colors.fog, 0.0018);

            // Camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 4000);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Radar
            const cvs = document.getElementById('radar-canvas');
            radarCtx = cvs.getContext('2d');

            // Lights
            const ambient = new THREE.AmbientLight(0x404040, 2.0);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(CONFIG.colors.light, 1.5);
            sun.position.set(500, 1500, 500);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 2048; sun.shadow.mapSize.height = 2048;
            sun.shadow.camera.far = 3000;
            const d = 1500;
            sun.shadow.camera.left = -d; sun.shadow.camera.right = d;
            sun.shadow.camera.top = d; sun.shadow.camera.bottom = -d;
            scene.add(sun);

            // Objects
            createTerrain();
            createRuins();
            createShip();
            createParticles();

            // Events
            window.addEventListener('resize', onResize);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);

            // Start
            startMission();
            animate();
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- CREATION ---
        function getTerrainHeight(x, z) {
            let h = (Math.sin(x * 0.002) * Math.cos(z * 0.002)) * 120;
            h += (Math.sin(x * 0.01 + z * 0.005) * Math.cos(z * 0.01)) * 40;
            h -= Math.abs(Math.sin(x * 0.005) * Math.cos(z * 0.005)) * 60;
            return h;
        }

        function createTerrain() {
            const size = 4000;
            const res = 128;
            const geo = new THREE.PlaneGeometry(size, size, res, res);
            geo.rotateX(-Math.PI / 2);

            const count = geo.attributes.position.count;
            const pos = geo.attributes.position;
            const colors = [];
            const col1 = new THREE.Color(0x050505);
            const col2 = new THREE.Color(0x443344);

            for(let i=0; i<count; i++) {
                const x = pos.getX(i);
                const z = pos.getZ(i);
                const y = getTerrainHeight(x, z);
                pos.setY(i, y);
                const t = (y + 100) / 250;
                const c = col1.clone().lerp(col2, Math.max(0, Math.min(1, t)));
                colors.push(c.r, c.g, c.b);
            }
            geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geo.computeVertexNormals();
            
            terrain = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({
                vertexColors: true, roughness: 0.9, metalness: 0.1, flatShading: true
            }));
            terrain.receiveShadow = true;
            scene.add(terrain);
        }

        function createRuins() {
            const mat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.2 });
            for(let i=0; i<40; i++) {
                const x = (Math.random()-0.5)*3000;
                const z = (Math.random()-0.5)*3000;
                const y = getTerrainHeight(x, z);
                const h = 60 + Math.random()*150;
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(20, h, 20), mat);
                mesh.position.set(x, y+h/2, z);
                mesh.rotation.set((Math.random()-0.5)*0.3, 0, (Math.random()-0.5)*0.3);
                mesh.castShadow = true; mesh.receiveShadow = true;
                scene.add(mesh);
            }
        }

        function createShip() {
            ship = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color: 0x8899aa, roughness: 0.4 });
            
            const body = new THREE.Mesh(new THREE.ConeGeometry(1.5, 10, 8), mat);
            body.rotation.x = Math.PI/2;
            ship.add(body);
            
            const wing = new THREE.Mesh(new THREE.BoxGeometry(12, 0.3, 4), mat);
            wing.position.set(0,0,2);
            wing.rotation.x = 0.1;
            ship.add(wing);

            const eng = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.5, 3, 8), mat);
            eng.rotation.x = Math.PI/2; eng.position.set(3,0,3);
            ship.add(eng);
            const eng2 = eng.clone(); eng2.position.set(-3,0,3);
            ship.add(eng2);

            const glow = new THREE.Mesh(new THREE.SphereGeometry(0.6), new THREE.MeshBasicMaterial({color: 0x00eaff}));
            glow.position.set(3,0,4.5);
            ship.add(glow);
            const glow2 = glow.clone(); glow2.position.set(-3,0,4.5);
            ship.add(glow2);

            ship.position.y = 200;
            scene.add(ship);
        }

        function createParticles() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<1500; i++) pos.push((Math.random()-0.5)*2000, (Math.random()-0.5)*500, (Math.random()-0.5)*2000);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            particles = new THREE.Points(geo, new THREE.PointsMaterial({color: 0xaaccff, size: 0.8, transparent: true, opacity: 0.4}));
            scene.add(particles);
        }

        // --- GAMEPLAY ---
        const LOOT_NAMES = ["Void Capacitor", "Star Chart", "Plasma Coil", "Ancient Drive", "Quantum Relic", "Neural Link", "Dark Matter Canister"];
        
        function startMission() {
            if(STATE.currentObj) scene.remove(STATE.currentObj);

            const angle = Math.random() * Math.PI * 2;
            const dist = 1000 + Math.random() * 1000;
            const x = ship.position.x + Math.cos(angle) * dist;
            const z = ship.position.z + Math.sin(angle) * dist;
            const y = getTerrainHeight(x, z) + 50;

            const isLegendary = Math.random() > 0.8;
            const col = isLegendary ? 0xffaa00 : 0x00eaff;
            const geo = isLegendary ? new THREE.IcosahedronGeometry(12, 1) : new THREE.OctahedronGeometry(8, 0);
            
            const mesh = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({color: col, emissive: col, emissiveIntensity: 2, wireframe: true}));
            mesh.position.set(x, y, z);
            
            const beam = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 2000, 6), new THREE.MeshBasicMaterial({color: col, transparent: true, opacity: 0.3}));
            beam.position.y = 1000;
            mesh.add(beam);

            scene.add(mesh);
            STATE.currentObj = mesh;
            STATE.currentObj.userData = { 
                rarity: isLegendary ? 'LEGENDARY' : 'COMMON',
                name: LOOT_NAMES[Math.floor(Math.random() * LOOT_NAMES.length)]
            };
            STATE.missionActive = true;

            showMsg("SIGNAL DETECTED");
            log(`New signature detected. Distance: ${Math.round(dist)}m`, "normal");
        }

        function completeMission() {
            if(!STATE.missionActive) return;
            STATE.missionActive = false;
            
            const data = STATE.currentObj.userData;
            scene.remove(STATE.currentObj);
            showMsg("ACQUISITION COMPLETE");

            // Credits
            const base = 200;
            const mult = data.rarity === 'LEGENDARY' ? 5 : 1;
            const luck = 1 + (STATE.upgrades.radar.lvl * 0.2);
            const val = Math.floor(base * mult * luck);
            STATE.credits += val;

            const style = data.rarity === 'LEGENDARY' ? 'log-legendary' : 'log-entry';
            log(`Acquired: ${data.name} (${val} CR)`, style);
            updateUI();

            setTimeout(startMission, 3000);
        }

        // --- RADAR LOGIC ---
        function updateRadar() {
            const ctx = radarCtx;
            const width = 220, height = 220;
            const cx = width/2, cy = height/2;
            const range = 2000; // Radar range

            // Clear
            ctx.clearRect(0,0,width,height);

            // Grid rings
            ctx.strokeStyle = 'rgba(0, 255, 100, 0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.arc(cx, cy, width*0.3, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.arc(cx, cy, width*0.45, 0, Math.PI*2); ctx.stroke();
            
            // Crosshair
            ctx.beginPath(); ctx.moveTo(cx-10, cy); ctx.lineTo(cx+10, cy); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx, cy-10); ctx.lineTo(cx, cy+10); ctx.stroke();

            // Player (Center Triangle)
            ctx.fillStyle = '#0ff';
            ctx.beginPath();
            ctx.moveTo(cx, cy-6); ctx.lineTo(cx-5, cy+5); ctx.lineTo(cx+5, cy+5);
            ctx.fill();

            // Objective Blip
            if(STATE.missionActive && STATE.currentObj) {
                // Get relative position
                const dx = STATE.currentObj.position.x - ship.position.x;
                const dz = STATE.currentObj.position.z - ship.position.z;

                // Get Player Rotation (Yaw)
                // We need to rotate the objective position by the negative of the ship's Y rotation
                // to make it appear relative to "forward" on the radar
                const euler = new THREE.Euler().setFromQuaternion(ship.quaternion, 'YXZ');
                const yaw = euler.y;

                // 2D Rotation Formula
                // radarX = x * cos(-yaw) - z * sin(-yaw)
                // radarY = x * sin(-yaw) + z * cos(-yaw)
                // Note: Three.js coordinates, Z is usually "forward/backward", X is "left/right"
                // Actually in this scene, -Z is forward. 
                
                const rotX = dx * Math.cos(yaw) - dz * Math.sin(yaw);
                const rotY = dx * Math.sin(yaw) + dz * Math.cos(yaw);

                // Map to canvas scale
                // We want forward (negative Z relative to ship) to be UP (negative Y on canvas)
                const mapX = cx + (rotX / range) * (width/2);
                const mapY = cy + (rotY / range) * (height/2);

                // Draw arrow if out of bounds
                const dist = Math.sqrt(Math.pow(mapX-cx, 2) + Math.pow(mapY-cy, 2));
                let drawX = mapX;
                let drawY = mapY;
                
                if (dist > width/2 - 10) {
                    const angle = Math.atan2(mapY - cy, mapX - cx);
                    drawX = cx + Math.cos(angle) * (width/2 - 15);
                    drawY = cy + Math.sin(angle) * (width/2 - 15);
                }

                ctx.fillStyle = STATE.currentObj.userData.rarity === 'LEGENDARY' ? '#ffd700' : '#f0f';
                ctx.beginPath();
                ctx.arc(drawX, drawY, 4, 0, Math.PI*2);
                ctx.fill();
                
                // Height indicator
                ctx.fillStyle = '#fff';
                ctx.font = '10px Arial';
                const dy = STATE.currentObj.position.y - ship.position.y;
                const char = dy > 50 ? '▲' : (dy < -50 ? '▼' : '');
                ctx.fillText(char, drawX+5, drawY);
            }
        }

        // --- LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            if(STATE.paused) return;

            const dt = Math.min(clock.getDelta(), 0.1);

            // Throttle
            if(INPUT.shift) STATE.throttle += CONFIG.flight.accel * dt;
            if(INPUT.ctrl) STATE.throttle -= CONFIG.flight.brake * dt;
            STATE.throttle = Math.max(0, Math.min(1, STATE.throttle));

            // Energy & Boost
            STATE.energy = Math.min(100, STATE.energy + (5 * STATE.upgrades.battery.lvl * dt));
            
            let isBoosting = false;
            let speedMult = STATE.throttle;
            if(STATE.throttle > 0.9 && INPUT.shift && STATE.energy > 0) {
                isBoosting = true;
                speedMult = 1.8;
                STATE.energy -= 20 * dt;
            }

            const maxS = CONFIG.flight.maxSpeedBase + (STATE.upgrades.engine.lvl * 0.5);
            const speed = maxS * speedMult;

            // Rotation (Separated)
            ship.rotateX((INPUT.s - INPUT.w) * CONFIG.flight.pitchSpeed * dt);
            ship.rotateY((INPUT.q - INPUT.e) * CONFIG.flight.turnSpeed * dt);
            ship.rotateZ((INPUT.a - INPUT.d) * CONFIG.flight.rollSpeed * dt);

            // Stability
            if(!INPUT.a && !INPUT.d) ship.rotation.z = THREE.MathUtils.lerp(ship.rotation.z, 0, dt * 2);

            // Move
            const fwd = new THREE.Vector3(0,0,-1).applyQuaternion(ship.quaternion);
            ship.position.add(fwd.multiplyScalar(speed * 100 * dt));

            // Ground Collision
            const gh = getTerrainHeight(ship.position.x, ship.position.z);
            if(ship.position.y < gh + 20) {
                ship.position.y += (20 - (ship.position.y - gh)) * 10 * dt;
                STATE.throttle *= 0.95;
            }

            // Camera
            const camOff = new THREE.Vector3(0, 15, isBoosting ? 50 : 40).applyMatrix4(ship.matrixWorld);
            camera.position.lerp(camOff, 0.1);
            camera.lookAt(ship.position.clone().add(fwd.multiplyScalar(100)));

            // Visuals
            const snap = 200;
            terrain.position.x = Math.floor(ship.position.x/snap)*snap;
            terrain.position.z = Math.floor(ship.position.z/snap)*snap;
            particles.position.copy(ship.position);

            if(STATE.missionActive && STATE.currentObj) {
                STATE.currentObj.rotation.y += dt;
                if(ship.position.distanceTo(STATE.currentObj.position) < 50) completeMission();
            }

            updateRadar();
            updateUI(speed * 100);
            renderer.render(scene, camera);
        }

        // --- UI ---
        function updateUI(spd) {
            document.getElementById('credits-val').innerText = STATE.credits;
            document.getElementById('spd-val').innerText = Math.round(spd) + " KM/H";
            document.getElementById('alt-val').innerText = Math.round(Math.max(0, ship.position.y)) + " M";
            document.getElementById('energy-bar').style.width = Math.max(0, STATE.energy) + "%";
            document.getElementById('energy-bar').style.backgroundColor = STATE.energy < 20 ? '#f44' : '#0ff';
        }

        function showMsg(txt) {
            const el = document.getElementById('center-msg');
            el.innerText = txt; el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 2000);
        }

        function log(msg, cls) {
            const box = document.getElementById('log-panel');
            const el = document.createElement('div');
            el.className = `log-entry ${cls}`;
            el.innerText = msg;
            box.appendChild(el); // append to bottom
            if(box.children.length > 4) box.firstChild.remove();
        }

        // --- SHOP ---
        function toggleShop() {
            STATE.paused = !STATE.paused;
            const modal = document.getElementById('shop-modal');
            modal.style.display = STATE.paused ? 'flex' : 'none';
            if(STATE.paused) renderShop(); else { clock.getDelta(); requestAnimationFrame(animate); }
        }

        function renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            Object.keys(STATE.upgrades).forEach(k => {
                const u = STATE.upgrades[k];
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div style="font-weight:bold; color:#0ff">${u.name} <span style="font-size:10px; color:#fff; background:#222; padding:2px">LVL ${u.lvl}</span></div>
                    <div style="font-size:11px; color:#aaa; margin-bottom:5px">${u.desc}</div>
                    <button class="btn-buy" onclick="buy('${k}')" style="${STATE.credits < u.cost ? 'opacity:0.5;pointer-events:none' : ''}">UPGRADE (${u.cost})</button>
                `;
                grid.appendChild(div);
            });
        }

        window.buy = function(k) {
            const u = STATE.upgrades[k];
            if(STATE.credits >= u.cost) {
                STATE.credits -= u.cost;
                u.lvl++;
                u.cost = Math.floor(u.cost * 1.5);
                renderShop();
                log(`Installed: ${u.name} Lvl ${u.lvl}`, 'log-rare');
            }
        };

        window.toggleShop = toggleShop;

        // --- INPUTS ---
        function onKeyDown(e) {
            if(e.code === 'Tab') { e.preventDefault(); toggleShop(); return; }
            if(STATE.paused) return;
            if(e.code === 'KeyW') INPUT.w = 1;
            if(e.code === 'KeyS') INPUT.s = 1;
            if(e.code === 'KeyA') INPUT.a = 1;
            if(e.code === 'KeyD') INPUT.d = 1;
            if(e.code === 'KeyQ') INPUT.q = 1;
            if(e.code === 'KeyE') INPUT.e = 1;
            if(e.code === 'ShiftLeft') INPUT.shift = 1;
            if(e.code === 'ControlLeft') INPUT.ctrl = 1;
        }
        function onKeyUp(e) {
            if(e.code === 'KeyW') INPUT.w = 0;
            if(e.code === 'KeyS') INPUT.s = 0;
            if(e.code === 'KeyA') INPUT.a = 0;
            if(e.code === 'KeyD') INPUT.d = 0;
            if(e.code === 'KeyQ') INPUT.q = 0;
            if(e.code === 'KeyE') INPUT.e = 0;
            if(e.code === 'ShiftLeft') INPUT.shift = 0;
            if(e.code === 'ControlLeft') INPUT.ctrl = 0;
        }

        window.onload = init;
    </script>
</body>
</html>